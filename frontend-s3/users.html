<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suite SEO — Usuarios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="suite-seo.css" rel="stylesheet">
  <script>if(localStorage.getItem('seo-theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
</head>
<body>

  <aside class="seo-sidebar"></aside>
  <header class="seo-header"></header>

  <!-- ══════════════════════════════════════════
       MAIN CONTENT
  ══════════════════════════════════════════ -->
  <main class="seo-main">
    <div class="seo-page-header">
      <h5>Usuarios</h5>
      <ul class="seo-breadcrumb">
        <li><a href="dashboard.html">Inicio</a></li>
        <li><span class="sep">›</span></li>
        <li>Usuarios</li>
      </ul>
    </div>
    <div class="seo-content">
      <div class="seo-card">

        <div class="seo-toolbar">
          <div class="seo-toolbar-left">
            <div class="seo-search-box">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input type="text" id="search-input" placeholder="Buscar usuario…">
            </div>
          </div>
          <div class="seo-toolbar-right">
            <button class="seo-btn seo-btn-primary" onclick="openCreateModal()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Nuevo usuario
            </button>
          </div>
        </div>

        <div class="seo-table-wrap">
          <table class="seo-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Creado</th>
                <th style="width:80px;text-align:center">Acciones</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <tr id="users-loading">
                <td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">
                  Cargando…
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </main>


  <!-- ══════════════════════════════════════════
       MODAL — CREAR / EDITAR
  ══════════════════════════════════════════ -->
  <div class="seo-modal-backdrop" id="modal-form">
    <div class="seo-modal">
      <div class="seo-modal-header">
        <h6 id="modal-title">Nuevo usuario</h6>
        <button class="seo-modal-close" onclick="closeModal('modal-form')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="seo-modal-body">
        <div class="seo-field">
          <label class="seo-label">Email</label>
          <input type="email" class="seo-input" id="f-email" placeholder="usuario@prensaiberica.es">
        </div>
        <div class="seo-field">
          <label class="seo-label" id="f-pass-label">Contraseña</label>
          <input type="password" class="seo-input" id="f-password" placeholder="Mínimo 8 caracteres">
          <div style="font-size:.72rem;color:var(--text-muted);margin-top:.3rem" id="f-pass-hint"></div>
        </div>
        <div class="seo-field">
          <label class="seo-label">Rol</label>
          <select class="seo-select" id="f-role">
            <option value="">Cargando roles…</option>
          </select>
        </div>
        <div class="seo-field">
          <label class="seo-switch">
            <input type="checkbox" id="f-active" checked>
            <span class="seo-switch-track"></span>
            Usuario activo
          </label>
        </div>
        <div id="form-error" class="seo-alert-error"></div>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeModal('modal-form')">Cancelar</button>
        <button class="seo-btn seo-btn-primary" id="form-submit-btn" onclick="submitForm()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════
       MODAL — CONFIRMAR BORRADO
  ══════════════════════════════════════════ -->
  <div class="seo-modal-backdrop" id="modal-delete">
    <div class="seo-modal" style="max-width:400px">
      <div class="seo-modal-header">
        <h6>Eliminar usuario</h6>
        <button class="seo-modal-close" onclick="closeModal('modal-delete')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="seo-modal-body">
        <p style="margin:0;color:var(--text-main)">
          ¿Seguro que quieres eliminar a <strong id="delete-email"></strong>?
          Esta acción no se puede deshacer.
        </p>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeModal('modal-delete')">Cancelar</button>
        <button class="seo-btn seo-btn-danger" id="delete-confirm-btn" onclick="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>


  <script src="js/layout.js"></script>
  <script>
    const API_BASE = 'https://vps-a351882a.vps.ovh.net';
    const token = localStorage.getItem('token');

    let allUsers  = [];
    let allRoles  = [];
    let editingId = null;
    let deletingId = null;

    /* ══════════════════════════════════════════
       USERS TABLE
    ══════════════════════════════════════════ */
    function roleLabel(name) {
      const map = { admin: 'Admin', responsable: 'Responsable', usuario: 'Usuario' };
      return map[name] || name;
    }

    function renderTable(users) {
      const tbody = document.getElementById('users-tbody');
      if (!users.length) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">Sin usuarios</td></tr>`;
        return;
      }
      tbody.innerHTML = users.map(u => `
        <tr>
          <td style="font-weight:500">${escHtml(u.email)}</td>
          <td>
            <span class="seo-pill ${u.role.name === 'admin' ? 'seo-pill-info' : 'seo-pill-muted'}">
              ${roleLabel(u.role.name)}
            </span>
          </td>
          <td>
            <span class="seo-pill ${u.is_active ? 'seo-pill-success' : 'seo-pill-danger'}">
              ${u.is_active ? 'Activo' : 'Inactivo'}
            </span>
          </td>
          <td style="color:var(--text-muted)">${new Date(u.created_at).toLocaleDateString('es-ES')}</td>
          <td>
            <div style="display:flex;gap:.35rem;justify-content:center">
              <button class="seo-btn seo-btn-icon" title="Editar" onclick="openEditModal(${u.id})">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="seo-btn seo-btn-icon danger" title="Eliminar" onclick="openDeleteModal(${u.id}, '${escHtml(u.email)}')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                  <path d="M10 11v6"/><path d="M14 11v6"/>
                  <path d="M9 6V4h6v2"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function escHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    async function fetchUsers() {
      try {
        const res = await fetch(`${API_BASE}/api/users/`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.status === 401) { logout(); return; }
        allUsers = await res.json();
        renderTable(allUsers);
      } catch (err) {
        document.getElementById('users-tbody').innerHTML =
          `<tr><td colspan="5" style="text-align:center;padding:2rem;color:#ea4d4d">Error al cargar usuarios</td></tr>`;
      }
    }

    async function fetchRoles() {
      try {
        const res = await fetch(`${API_BASE}/api/users/roles`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        allRoles = await res.json();
      } catch (err) { allRoles = []; }
    }

    /* ── Search ── */
    document.getElementById('search-input').addEventListener('input', function() {
      const q = this.value.toLowerCase();
      renderTable(allUsers.filter(u =>
        u.email.toLowerCase().includes(q) || u.role.name.toLowerCase().includes(q)
      ));
    });

    /* ══════════════════════════════════════════
       MODALS
    ══════════════════════════════════════════ */
    function openModal(id) {
      document.getElementById(id).classList.add('show');
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }
    /* Close on backdrop click */
    document.querySelectorAll('.seo-modal-backdrop').forEach(el => {
      el.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });

    function populateRoleSelect(selectedId) {
      const sel = document.getElementById('f-role');
      sel.innerHTML = allRoles.map(r =>
        `<option value="${r.id}" ${r.id === selectedId ? 'selected' : ''}>${roleLabel(r.name)}</option>`
      ).join('');
    }

    function clearFormError() {
      const el = document.getElementById('form-error');
      el.textContent = ''; el.classList.remove('show');
    }
    function showFormError(msg) {
      const el = document.getElementById('form-error');
      el.textContent = msg; el.classList.add('show');
    }

    function openCreateModal() {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Nuevo usuario';
      document.getElementById('f-email').value    = '';
      document.getElementById('f-password').value = '';
      document.getElementById('f-active').checked = true;
      document.getElementById('f-pass-label').textContent = 'Contraseña';
      document.getElementById('f-pass-hint').textContent  = '';
      document.getElementById('f-email').disabled = false;
      populateRoleSelect(allRoles[allRoles.length - 1]?.id);
      clearFormError();
      openModal('modal-form');
      setTimeout(() => document.getElementById('f-email').focus(), 150);
    }

    function openEditModal(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      editingId = userId;
      document.getElementById('modal-title').textContent  = 'Editar usuario';
      document.getElementById('f-email').value    = user.email;
      document.getElementById('f-email').disabled = false;
      document.getElementById('f-password').value = '';
      document.getElementById('f-active').checked = user.is_active;
      document.getElementById('f-pass-label').textContent = 'Nueva contraseña';
      document.getElementById('f-pass-hint').textContent  = 'Deja en blanco para no cambiarla';
      populateRoleSelect(user.role.id);
      clearFormError();
      openModal('modal-form');
      setTimeout(() => document.getElementById('f-email').focus(), 150);
    }

    async function submitForm() {
      clearFormError();
      const email    = document.getElementById('f-email').value.trim();
      const password = document.getElementById('f-password').value;
      const roleId   = parseInt(document.getElementById('f-role').value);
      const isActive = document.getElementById('f-active').checked;
      const btn      = document.getElementById('form-submit-btn');

      if (!email) { showFormError('El email es obligatorio'); return; }
      if (!editingId && !password) { showFormError('La contraseña es obligatoria'); return; }
      if (!editingId && password.length < 8) { showFormError('La contraseña debe tener al menos 8 caracteres'); return; }

      btn.disabled = true; btn.textContent = 'Guardando…';

      try {
        const body = { email, role_id: roleId, is_active: isActive };
        if (password) body.password = password;

        const url    = editingId ? `${API_BASE}/api/users/${editingId}` : `${API_BASE}/api/users/`;
        const method = editingId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const d = await res.json();
          showFormError(d.detail || 'Error al guardar');
          return;
        }
        closeModal('modal-form');
        await fetchUsers();
      } catch (err) {
        showFormError('Error de red');
      } finally {
        btn.disabled = false; btn.textContent = 'Guardar';
      }
    }

    /* ── Delete ── */
    function openDeleteModal(userId, email) {
      deletingId = userId;
      document.getElementById('delete-email').textContent = email;
      openModal('modal-delete');
    }

    async function confirmDelete() {
      if (!deletingId) return;
      const btn = document.getElementById('delete-confirm-btn');
      btn.disabled = true; btn.textContent = 'Eliminando…';
      try {
        const res = await fetch(`${API_BASE}/api/users/${deletingId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok && res.status !== 204) {
          const d = await res.json();
          alert(d.detail || 'Error al eliminar');
          return;
        }
        closeModal('modal-delete');
        await fetchUsers();
      } catch (err) {
        alert('Error de red');
      } finally {
        btn.disabled = false; btn.textContent = 'Eliminar';
        deletingId = null;
      }
    }

    /* ── Init ── */
    async function init() {
      const user = await initLayout('users');
      if (!user || user.role.name !== 'admin') { window.location.href = 'dashboard.html'; return; }
      await Promise.all([fetchRoles(), fetchUsers()]);
    }
    init();
  </script>
</body>
</html>
