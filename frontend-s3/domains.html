<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suite SEO — Dominios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="suite-seo.css" rel="stylesheet">
  <script>if(localStorage.getItem('seo-theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
</head>
<body>

  <aside class="seo-sidebar"></aside>
  <header class="seo-header"></header>

  <!-- MAIN -->
  <main class="seo-main">
    <div class="seo-page-header">
      <h5>Dominios</h5>
      <ul class="seo-breadcrumb">
        <li><a href="dashboard.html">Inicio</a></li>
        <li><span class="sep">›</span></li>
        <li>Dominios</li>
      </ul>
    </div>
    <div class="seo-content">

      <!-- TABLA DOMINIOS -->
      <div class="seo-card">
        <div class="seo-toolbar">
          <div class="seo-toolbar-left">
            <div class="seo-search-box">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input type="text" id="search-input" placeholder="Buscar dominio…">
            </div>
          </div>
          <div class="seo-toolbar-right">
            <button class="seo-btn seo-btn-primary" onclick="openCreateDomain()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Nuevo dominio
            </button>
          </div>
        </div>

        <div class="seo-table-wrap">
          <table class="seo-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Dominio</th>
                <th>URL completa</th>
                <th>Categoría</th>
                <th>Añadido</th>
                <th style="width:80px;text-align:center">Acciones</th>
              </tr>
            </thead>
            <tbody id="domains-tbody">
              <tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CATEGORÍAS -->
      <div class="seo-card">
        <div class="seo-toolbar" style="margin-bottom:1rem">
          <div class="seo-toolbar-left">
            <span style="font-size:.88rem;font-weight:700;color:var(--text-main)">Categorías</span>
          </div>
          <div class="seo-toolbar-right">
            <input type="text" class="seo-input" id="new-cat-input"
              placeholder="Nueva categoría…"
              style="width:190px;padding:.38rem .75rem"
              onkeydown="if(event.key==='Enter')addCategory()">
            <button class="seo-btn seo-btn-primary" onclick="addCategory()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Añadir
            </button>
          </div>
        </div>
        <div class="seo-table-wrap">
          <table class="seo-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Dominios</th>
                <th style="width:80px;text-align:center">Acciones</th>
              </tr>
            </thead>
            <tbody id="cat-list">
              <tr><td colspan="3" style="text-align:center;padding:1.5rem;color:var(--text-muted)">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </main>


  <!-- MODAL CREAR / EDITAR DOMINIO -->
  <div class="seo-modal-backdrop" id="modal-domain">
    <div class="seo-modal">
      <div class="seo-modal-header">
        <h6 id="domain-modal-title">Nuevo dominio</h6>
        <button class="seo-modal-close" onclick="closeModal('modal-domain')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="seo-modal-body">
        <div class="seo-field">
          <label class="seo-label">Nombre</label>
          <input type="text" class="seo-input" id="f-name" placeholder="ej. Información">
        </div>
        <div class="seo-field">
          <label class="seo-label">URL completa</label>
          <input type="url" class="seo-input" id="f-full-url" placeholder="https://www.informacion.es">
        </div>
        <div class="seo-field">
          <label class="seo-label">Dominio</label>
          <input type="text" class="seo-input" id="f-domain" placeholder="informacion.es">
        </div>
        <div class="seo-field">
          <label class="seo-label">Categoría</label>
          <select class="seo-select" id="f-category">
            <option value="">Selecciona una categoría</option>
          </select>
        </div>
        <div id="domain-form-error" class="seo-alert-error"></div>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeModal('modal-domain')">Cancelar</button>
        <button class="seo-btn seo-btn-primary" id="domain-submit-btn" onclick="submitDomain()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRMAR BORRADO DOMINIO -->
  <div class="seo-modal-backdrop" id="modal-delete-domain">
    <div class="seo-modal" style="max-width:400px">
      <div class="seo-modal-header">
        <h6>Eliminar dominio</h6>
        <button class="seo-modal-close" onclick="closeModal('modal-delete-domain')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="seo-modal-body">
        <p style="margin:0;color:var(--text-main)">
          ¿Eliminar <strong id="delete-domain-name"></strong>? Esta acción no se puede deshacer.
        </p>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeModal('modal-delete-domain')">Cancelar</button>
        <button class="seo-btn seo-btn-danger" id="delete-domain-btn" onclick="confirmDeleteDomain()">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR CATEGORÍA -->
  <div class="seo-modal-backdrop" id="modal-edit-cat">
    <div class="seo-modal" style="max-width:380px">
      <div class="seo-modal-header">
        <h6>Editar categoría</h6>
        <button class="seo-modal-close" onclick="closeModal('modal-edit-cat')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="seo-modal-body">
        <div class="seo-field">
          <label class="seo-label">Nombre</label>
          <input type="text" class="seo-input" id="edit-cat-input" placeholder="Nombre de la categoría">
        </div>
        <div id="edit-cat-error" class="seo-alert-error"></div>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeModal('modal-edit-cat')">Cancelar</button>
        <button class="seo-btn seo-btn-primary" id="edit-cat-btn" onclick="confirmEditCat()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRMAR BORRADO CATEGORÍA -->
  <div class="seo-modal-backdrop" id="modal-delete-cat">
    <div class="seo-modal" style="max-width:400px">
      <div class="seo-modal-header">
        <h6>Eliminar categoría</h6>
        <button class="seo-modal-close" onclick="closeModal('modal-delete-cat')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="seo-modal-body">
        <p style="margin:0;color:var(--text-main)">
          ¿Eliminar la categoría <strong id="delete-cat-name"></strong>?
          Solo es posible si no tiene dominios asignados.
        </p>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeModal('modal-delete-cat')">Cancelar</button>
        <button class="seo-btn seo-btn-danger" id="delete-cat-btn" onclick="confirmDeleteCat()">Eliminar</button>
      </div>
    </div>
  </div>


  <script src="js/layout.js"></script>
  <script>
    const API_BASE = 'https://vps-a351882a.vps.ovh.net';
    const token = localStorage.getItem('token');

    let allDomains    = [];
    let allCategories = [];
    let editingDomId  = null;
    let deletingDomId = null;
    let deletingCatId = null;
    let editingCatId  = null;

    /* ── Modals ── */
    function openModal(id)  { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    document.querySelectorAll('.seo-modal-backdrop').forEach(el => {
      el.addEventListener('click', function(e) { if (e.target === this) closeModal(this.id); });
    });

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* ══════════════════════════════════════════
       CATEGORÍAS
    ══════════════════════════════════════════ */
    async function fetchCategories() {
      try {
        const res = await fetch(`${API_BASE}/api/domains/categories`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        allCategories = await res.json();
        renderCategories();
        populateCategorySelect();
      } catch (err) { console.error(err); }
    }

    function renderCategories() {
      const tbody = document.getElementById('cat-list');
      if (!allCategories.length) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:1.5rem;color:var(--text-muted)">Sin categorías</td></tr>`;
        return;
      }
      tbody.innerHTML = allCategories.map(c => {
        const count = allDomains.filter(d => d.category.id === c.id).length;
        return `
        <tr>
          <td style="font-weight:500">${escHtml(c.name)}</td>
          <td style="color:var(--text-muted)">${count} dominio${count !== 1 ? 's' : ''}</td>
          <td>
            <div style="display:flex;gap:.35rem;justify-content:center">
              <button class="seo-btn seo-btn-icon" title="Editar" onclick="openEditCat(${c.id},'${escHtml(c.name)}')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="seo-btn seo-btn-icon danger" title="Eliminar" onclick="openDeleteCat(${c.id},'${escHtml(c.name)}')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                  <path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    function populateCategorySelect(selectedId) {
      const sel = document.getElementById('f-category');
      sel.innerHTML = `<option value="">Selecciona una categoría</option>` +
        allCategories.map(c =>
          `<option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${escHtml(c.name)}</option>`
        ).join('');
    }

    async function addCategory() {
      const input = document.getElementById('new-cat-input');
      const name  = input.value.trim();
      if (!name) return;
      try {
        const res = await fetch(`${API_BASE}/api/domains/categories`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ name })
        });
        if (!res.ok) { const d = await res.json(); alert(d.detail || 'Error'); return; }
        input.value = '';
        await fetchCategories();
        await fetchDomains();
      } catch (err) { alert('Error de red'); }
    }

    function openEditCat(id, name) {
      editingCatId = id;
      document.getElementById('edit-cat-input').value = name;
      const err = document.getElementById('edit-cat-error');
      err.textContent = ''; err.classList.remove('show');
      openModal('modal-edit-cat');
      setTimeout(() => document.getElementById('edit-cat-input').focus(), 150);
    }

    async function confirmEditCat() {
      const name = document.getElementById('edit-cat-input').value.trim();
      const err  = document.getElementById('edit-cat-error');
      err.textContent = ''; err.classList.remove('show');
      if (!name) { err.textContent = 'El nombre es obligatorio'; err.classList.add('show'); return; }
      const btn = document.getElementById('edit-cat-btn');
      btn.disabled = true; btn.textContent = 'Guardando…';
      try {
        const res = await fetch(`${API_BASE}/api/domains/categories/${editingCatId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ name })
        });
        if (!res.ok) { const d = await res.json(); err.textContent = d.detail || 'Error'; err.classList.add('show'); return; }
        closeModal('modal-edit-cat');
        await fetchCategories();
        await fetchDomains();
      } catch (e) { err.textContent = 'Error de red'; err.classList.add('show'); }
      finally { btn.disabled = false; btn.textContent = 'Guardar'; editingCatId = null; }
    }

    function openDeleteCat(id, name) {
      deletingCatId = id;
      document.getElementById('delete-cat-name').textContent = name;
      openModal('modal-delete-cat');
    }

    async function confirmDeleteCat() {
      if (!deletingCatId) return;
      const btn = document.getElementById('delete-cat-btn');
      btn.disabled = true; btn.textContent = 'Eliminando…';
      try {
        const res = await fetch(`${API_BASE}/api/domains/categories/${deletingCatId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok && res.status !== 204) {
          const d = await res.json(); alert(d.detail || 'Error al eliminar'); return;
        }
        closeModal('modal-delete-cat');
        await fetchCategories();
      } catch (err) { alert('Error de red'); }
      finally { btn.disabled = false; btn.textContent = 'Eliminar'; deletingCatId = null; }
    }

    /* ══════════════════════════════════════════
       DOMINIOS
    ══════════════════════════════════════════ */
    function catLabel(name) {
      const map = {
        nacionales: 'Nacionales', regionales: 'Regionales',
        deportivos: 'Deportivos', verticales: 'Verticales', revistas: 'Revistas'
      };
      return map[name] || name;
    }

    function renderDomains(list) {
      const tbody = document.getElementById('domains-tbody');
      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">Sin dominios</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(d => `
        <tr>
          <td style="font-weight:500">${escHtml(d.name)}</td>
          <td style="font-family:monospace;font-size:.78rem;color:var(--text-muted)">${escHtml(d.domain)}</td>
          <td>
            <a href="${escHtml(d.full_url)}" target="_blank" rel="noopener"
              style="color:var(--primary);font-size:.78rem;font-family:monospace">
              ${escHtml(d.full_url)}
            </a>
          </td>
          <td><span class="seo-pill seo-pill-muted">${escHtml(catLabel(d.category.name))}</span></td>
          <td style="color:var(--text-muted)">${new Date(d.created_at).toLocaleDateString('es-ES')}</td>
          <td>
            <div style="display:flex;gap:.35rem;justify-content:center">
              <button class="seo-btn seo-btn-icon" title="Editar" onclick="openEditDomain(${d.id})">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="seo-btn seo-btn-icon danger" title="Eliminar" onclick="openDeleteDomain(${d.id},'${escHtml(d.name)}')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                  <path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');

    }

    async function fetchDomains() {
      try {
        const res = await fetch(`${API_BASE}/api/domains/`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.status === 401) { logout(); return; }
        allDomains = await res.json();
        renderDomains(allDomains);
        renderCategories();
      } catch (err) {
        document.getElementById('domains-tbody').innerHTML =
          `<tr><td colspan="6" style="text-align:center;padding:2rem;color:#ea4d4d">Error al cargar</td></tr>`;
      }
    }

    /* Búsqueda */
    document.getElementById('search-input').addEventListener('input', function() {
      const q = this.value.toLowerCase();
      renderDomains(allDomains.filter(d =>
        d.name.toLowerCase().includes(q) ||
        d.domain.toLowerCase().includes(q) ||
        d.category.name.toLowerCase().includes(q)
      ));
    });

    /* CRUD dominios */
    function clearDomainError() {
      const el = document.getElementById('domain-form-error');
      el.textContent = ''; el.classList.remove('show');
    }
    function showDomainError(msg) {
      const el = document.getElementById('domain-form-error');
      el.textContent = msg; el.classList.add('show');
    }

    function openCreateDomain() {
      editingDomId = null;
      document.getElementById('domain-modal-title').textContent = 'Nuevo dominio';
      document.getElementById('f-name').value     = '';
      document.getElementById('f-full-url').value = '';
      document.getElementById('f-domain').value   = '';
      populateCategorySelect();
      clearDomainError();
      openModal('modal-domain');
      setTimeout(() => document.getElementById('f-name').focus(), 150);
    }

    function openEditDomain(id) {
      const d = allDomains.find(x => x.id === id);
      if (!d) return;
      editingDomId = id;
      document.getElementById('domain-modal-title').textContent = 'Editar dominio';
      document.getElementById('f-name').value     = d.name;
      document.getElementById('f-full-url').value = d.full_url;
      document.getElementById('f-domain').value   = d.domain;
      populateCategorySelect(d.category.id);
      clearDomainError();
      openModal('modal-domain');
      setTimeout(() => document.getElementById('f-name').focus(), 150);
    }

    async function submitDomain() {
      clearDomainError();
      const name     = document.getElementById('f-name').value.trim();
      const full_url = document.getElementById('f-full-url').value.trim();
      const domain   = document.getElementById('f-domain').value.trim();
      const cat_id   = parseInt(document.getElementById('f-category').value);
      const btn      = document.getElementById('domain-submit-btn');

      if (!name)     { showDomainError('El nombre es obligatorio'); return; }
      if (!full_url) { showDomainError('La URL completa es obligatoria'); return; }
      if (!domain)   { showDomainError('El dominio es obligatorio'); return; }
      if (!cat_id)   { showDomainError('Selecciona una categoría'); return; }

      btn.disabled = true; btn.textContent = 'Guardando…';
      try {
        const body   = { name, full_url, domain, category_id: cat_id };
        const url    = editingDomId ? `${API_BASE}/api/domains/${editingDomId}` : `${API_BASE}/api/domains/`;
        const method = editingDomId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(body)
        });
        if (!res.ok) { const d = await res.json(); showDomainError(d.detail || 'Error al guardar'); return; }
        closeModal('modal-domain');
        await fetchDomains();
      } catch (err) { showDomainError('Error de red'); }
      finally { btn.disabled = false; btn.textContent = 'Guardar'; }
    }

    function openDeleteDomain(id, name) {
      deletingDomId = id;
      document.getElementById('delete-domain-name').textContent = name;
      openModal('modal-delete-domain');
    }

    async function confirmDeleteDomain() {
      if (!deletingDomId) return;
      const btn = document.getElementById('delete-domain-btn');
      btn.disabled = true; btn.textContent = 'Eliminando…';
      try {
        const res = await fetch(`${API_BASE}/api/domains/${deletingDomId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok && res.status !== 204) { const d = await res.json(); alert(d.detail || 'Error'); return; }
        closeModal('modal-delete-domain');
        await fetchDomains();
      } catch (err) { alert('Error de red'); }
      finally { btn.disabled = false; btn.textContent = 'Eliminar'; deletingDomId = null; }
    }

    /* ── Init ── */
    async function init() {
      const user = await initLayout('domains');
      if (!user || user.role.name !== 'admin') { window.location.href = 'dashboard.html'; return; }
      await fetchCategories();
      await fetchDomains();
    }
    init();
  </script>
</body>
</html>
