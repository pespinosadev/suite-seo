<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suite SEO — Historial de correos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="suite-seo.css" rel="stylesheet">
  <script>if(localStorage.getItem('seo-theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
</head>
<body>

  <aside class="seo-sidebar"></aside>
  <header class="seo-header"></header>

  <main class="seo-main">
    <div class="seo-page-header">
      <h5>Historial de correos</h5>
      <ul class="seo-breadcrumb">
        <li><a href="dashboard.html">Inicio</a></li>
        <li><span class="sep">›</span></li>
        <li><a href="topics.html">Temas del día</a></li>
        <li><span class="sep">›</span></li>
        <li>Historial</li>
      </ul>
    </div>

    <div class="seo-content">
      <div class="seo-card">
        <div class="seo-table-wrap">
          <table class="seo-table">
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Enviado por</th>
                <th>Destinatarios</th>
                <th>Asunto</th>
                <th style="text-align:center">Temas</th>
                <th id="th-delete" style="display:none"></th>
              </tr>
            </thead>
            <tbody id="history-tbody">
              <tr id="history-loading">
                <td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">
                  Cargando…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- ── Modal: Ver correo ── -->
  <div class="seo-modal-backdrop" id="modal-email-detail"
       onclick="if(event.target===this)closeDetail()">
    <div class="seo-modal" style="max-width:760px;display:flex;flex-direction:column;max-height:92vh">
      <div class="seo-modal-header">
        <div style="display:flex;flex-direction:column;gap:.15rem;overflow:hidden">
          <span id="detail-subject" style="font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">—</span>
          <span id="detail-meta" style="font-size:.72rem;color:var(--text-muted)">—</span>
        </div>
        <button class="seo-modal-close" onclick="closeDetail()">✕</button>
      </div>
      <div class="seo-modal-body" style="flex:1;overflow:hidden;padding:0">
        <iframe id="detail-iframe"
                style="width:100%;height:100%;border:none;min-height:520px"
                sandbox="allow-same-origin"></iframe>
      </div>
      <div class="seo-modal-footer">
        <button class="seo-btn seo-btn-outline" onclick="closeDetail()">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="js/layout.js"></script>
  <script>
    const API_BASE = 'https://vps-a351882a.vps.ovh.net';
    const token = localStorage.getItem('token');
    let isAdmin = false;

    function escHtml(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('es-ES', {
        day: '2-digit', month: '2-digit', year: 'numeric'
      }) + ' · ' + d.toLocaleTimeString('es-ES', {
        hour: '2-digit', minute: '2-digit'
      });
    }

    async function fetchHistory() {
      try {
        const res = await fetch(`${API_BASE}/api/topics/email-logs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.status === 401) { logout(); return; }
        if (!res.ok) throw new Error('Error ' + res.status);
        const logs = await res.json();
        renderHistory(logs);
      } catch(e) {
        document.getElementById('history-tbody').innerHTML =
          `<tr><td colspan="5" style="text-align:center;padding:2rem;color:#ea4d4d">Error al cargar el historial</td></tr>`;
      }
    }

    function renderHistory(logs) {
      const tbody = document.getElementById('history-tbody');
      const cols = isAdmin ? 6 : 5;
      if (!logs.length) {
        tbody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center;padding:2rem;color:var(--text-muted)">Todavía no se ha enviado ningún correo</td></tr>`;
        return;
      }
      if (isAdmin) document.getElementById('th-delete').style.display = '';
      tbody.innerHTML = logs.map(log => {
        const recips = Array.isArray(log.recipients) ? log.recipients : [];
        const recipLabel = recips.length === 1
          ? escHtml(recips[0])
          : `${recips.length} destinatarios`;
        const recipTitle = recips.join(', ');
        const deleteCell = isAdmin
          ? `<td style="text-align:center;white-space:nowrap" onclick="event.stopPropagation()">
               <button class="seo-btn seo-btn-icon" title="Eliminar" style="color:#ef4444" onclick="deleteLog(${log.id})">
                 <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="currentColor">
                   <polyline points="3 6 5 6 21 6"/>
                   <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                   <path d="M10 11v6"/><path d="M14 11v6"/>
                 </svg>
               </button>
             </td>`
          : '';
        return `
          <tr style="cursor:pointer" onclick="openDetail(${log.id})" title="Ver correo">
            <td style="white-space:nowrap;color:var(--text-muted)">${escHtml(formatDate(log.sent_at))}</td>
            <td style="font-weight:500">${escHtml(log.sender_email)}</td>
            <td title="${escHtml(recipTitle)}" style="color:var(--text-muted)">${recipLabel}</td>
            <td>${escHtml(log.subject)}</td>
            <td style="text-align:center">
              <span class="seo-pill seo-pill-muted">${log.topic_count}</span>
            </td>
            ${deleteCell}
          </tr>`;
      }).join('');
    }

    async function deleteLog(id) {
      if (!confirm('¿Eliminar este registro del historial?')) return;
      try {
        const res = await fetch(`${API_BASE}/api/topics/email-logs/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) await fetchHistory();
        else { const d = await res.json().catch(() => ({})); alert(d.detail || 'Error al eliminar'); }
      } catch(e) { alert('Error de red'); }
    }

    async function openDetail(logId) {
      // Show modal with loading state
      const modal = document.getElementById('modal-email-detail');
      const iframe = document.getElementById('detail-iframe');
      document.getElementById('detail-subject').textContent = 'Cargando…';
      document.getElementById('detail-meta').textContent = '';
      iframe.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:Inter,sans-serif;color:#999;font-size:.85rem">Cargando correo…</div>';
      modal.classList.add('show');

      try {
        const res = await fetch(`${API_BASE}/api/topics/email-logs/${logId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Error ' + res.status);
        const log = await res.json();

        const recips = Array.isArray(log.recipients) ? log.recipients : [];
        document.getElementById('detail-subject').textContent = log.subject;
        document.getElementById('detail-meta').textContent =
          formatDate(log.sent_at) + ' · ' + log.sender_email +
          ' → ' + recips.join(', ');
        iframe.srcdoc = log.html_body;
      } catch(e) {
        iframe.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:Inter,sans-serif;color:#ea4d4d;font-size:.85rem">Error al cargar el correo</div>';
      }
    }

    function closeDetail() {
      document.getElementById('modal-email-detail').classList.remove('show');
      document.getElementById('detail-iframe').srcdoc = '';
    }

    async function init() {
      const user = await initLayout('topics');
      isAdmin = !!(user && user.role.name === 'admin');
      await fetchHistory();
    }
    init();
  </script>
</body>
</html>
