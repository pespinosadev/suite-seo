<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suite SEO — Mi cuenta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="suite-seo.css" rel="stylesheet">
  <script>if(localStorage.getItem('seo-theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
  <style>
    .account-avatar-wrap {
      position: relative;
      width: 96px;
      height: 96px;
      cursor: pointer;
      margin: 0 auto 1.25rem;
    }
    .account-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      font-size: 2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: cover;
      background-position: center;
      overflow: hidden;
    }
    .account-avatar-overlay {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(0,0,0,.45);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity .2s;
    }
    .account-avatar-wrap:hover .account-avatar-overlay { opacity: 1; }
    .account-section-title {
      font-size: .7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .07em;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
    .account-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .75rem;
    }
    @media (max-width: 540px) { .account-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <aside class="seo-sidebar"></aside>
  <header class="seo-header"></header>

  <!-- ══════════════════════════════════════════
       MAIN
  ══════════════════════════════════════════ -->
  <main class="seo-main">
    <div class="seo-page-header">
      <h5>Mi cuenta</h5>
      <ul class="seo-breadcrumb">
        <li><a href="dashboard.html">Inicio</a></li>
        <li><span class="sep">›</span></li>
        <li>Mi cuenta</li>
      </ul>
    </div>

    <div class="seo-content" style="max-width:600px">

      <!-- ── Foto + datos personales ── -->
      <div class="seo-card">
        <div class="account-section-title">Perfil</div>

        <!-- Avatar -->
        <div class="account-avatar-wrap" onclick="document.getElementById('avatar-input').click()" title="Cambiar foto">
          <div class="account-avatar" id="account-avatar-el"></div>
          <div class="account-avatar-overlay">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
          </div>
        </div>
        <input type="file" id="avatar-input" accept="image/*" style="display:none">

        <div class="account-grid" style="margin-bottom:.75rem">
          <div>
            <label style="font-size:.78rem;font-weight:600;color:var(--text-label);display:block;margin-bottom:.3rem">Nombre</label>
            <input class="seo-input" type="text" id="f-first-name" placeholder="Tu nombre">
          </div>
          <div>
            <label style="font-size:.78rem;font-weight:600;color:var(--text-label);display:block;margin-bottom:.3rem">Apellidos</label>
            <input class="seo-input" type="text" id="f-last-name" placeholder="Tus apellidos">
          </div>
        </div>
        <div style="margin-bottom:.75rem">
          <label style="font-size:.78rem;font-weight:600;color:var(--text-label);display:block;margin-bottom:.3rem">Email</label>
          <input class="seo-input" type="email" id="f-email" readonly style="opacity:.6;cursor:not-allowed">
        </div>
        <div class="seo-form-error" id="profile-error"></div>
        <div style="display:flex;justify-content:flex-end">
          <button class="seo-btn seo-btn-primary" id="btn-save-profile" onclick="saveProfile()">Guardar perfil</button>
        </div>
      </div>

      <!-- ── Contraseña de la aplicación ── -->
      <div class="seo-card">
        <div class="account-section-title">Contraseña de la aplicación</div>
        <div style="display:flex;flex-direction:column;gap:.65rem">
          <div>
            <label style="font-size:.78rem;font-weight:600;color:var(--text-label);display:block;margin-bottom:.3rem">Contraseña actual</label>
            <input class="seo-input" type="password" id="f-current-pw" placeholder="••••••••" autocomplete="current-password">
          </div>
          <div class="account-grid">
            <div>
              <label style="font-size:.78rem;font-weight:600;color:var(--text-label);display:block;margin-bottom:.3rem">Nueva contraseña</label>
              <input class="seo-input" type="password" id="f-new-pw" placeholder="••••••••" autocomplete="new-password">
            </div>
            <div>
              <label style="font-size:.78rem;font-weight:600;color:var(--text-label);display:block;margin-bottom:.3rem">Confirmar contraseña</label>
              <input class="seo-input" type="password" id="f-confirm-pw" placeholder="••••••••" autocomplete="new-password">
            </div>
          </div>
        </div>
        <div class="seo-form-error" id="pw-error" style="margin-top:.5rem"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:.75rem">
          <button class="seo-btn seo-btn-primary" id="btn-save-pw" onclick="savePassword()">Cambiar contraseña</button>
        </div>
      </div>

      <!-- ── Contraseña de correo (SMTP) ── -->
      <div class="seo-card">
        <div class="account-section-title">Contraseña de correo (Office 365)</div>
        <p style="font-size:.8rem;color:var(--text-secondary);margin:0 0 .75rem">
          Necesaria para enviar los "Temas del día" desde tu cuenta de correo.
          Se guarda de forma segura y solo se usa para el envío de correos.
        </p>
        <!-- Vista: contraseña guardada -->
        <div id="smtp-saved-row" style="display:none;align-items:center;gap:.75rem;padding:.55rem .85rem;background:var(--card-alt-bg,rgba(0,0,0,.04));border:1px solid var(--border);border-radius:8px;margin-bottom:.75rem">
          <span style="font-size:1.1rem;letter-spacing:.15em;color:var(--text-secondary)">••••••••</span>
          <div style="flex:1"></div>
          <button class="seo-btn" style="padding:.3rem .75rem;font-size:.78rem;color:#e5534b;border-color:#e5534b" onclick="clearSmtp()">Borrar</button>
          <button class="seo-btn seo-btn-primary" style="padding:.3rem .75rem;font-size:.78rem" onclick="showSmtpInput()">Cambiar</button>
        </div>
        <!-- Vista: input -->
        <div id="smtp-input-row">
          <input class="seo-input" type="password" id="f-smtp-pw" placeholder="Tu contraseña de Office 365" autocomplete="new-password">
          <div style="display:flex;justify-content:flex-end;margin-top:.75rem;gap:.5rem">
            <button class="seo-btn" id="btn-cancel-smtp" onclick="cancelSmtpInput()" style="display:none">Cancelar</button>
            <button class="seo-btn seo-btn-primary" id="btn-save-smtp" onclick="saveSmtp()">Guardar contraseña de correo</button>
          </div>
        </div>
        <div class="seo-form-error" id="smtp-error"></div>
      </div>

    </div>
  </main>

  <!-- ══════════════════════════════════════════
       SCRIPTS
  ══════════════════════════════════════════ -->
  <script src="js/layout.js"></script>
  <script>
    const API_BASE = 'https://vps-a351882a.vps.ovh.net';
    const token = localStorage.getItem('token');

    /* ── Utils ── */
    function setAvatarEl(el, user) {
      if (user.avatar) {
        el.style.backgroundImage = `url(${user.avatar})`;
        el.textContent = '';
      } else {
        const initials = ((user.first_name || user.email.split('@')[0]).slice(0,1) +
                          (user.last_name || '').slice(0,1)).toUpperCase() || '--';
        el.style.backgroundImage = '';
        el.textContent = initials;
      }
    }
    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg; el.classList.add('show');
    }
    function clearError(id) {
      const el = document.getElementById(id);
      el.textContent = ''; el.classList.remove('show');
    }
    function setBtnLoading(id, loading, label) {
      const btn = document.getElementById(id);
      btn.disabled = loading;
      btn.textContent = loading ? 'Guardando…' : label;
    }

    /* ── Load user (form only) ── */
    async function loadUser() {
      const res = await fetch(`${API_BASE}/api/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.status === 401) { logout(); return; }
      const user = await res.json();
      document.getElementById('f-first-name').value = user.first_name || '';
      document.getElementById('f-last-name').value = user.last_name || '';
      document.getElementById('f-email').value = user.email;
      setAvatarEl(document.getElementById('account-avatar-el'), user);
      renderSmtpState(user.has_smtp_password);
    }

    /* ── Avatar upload ── */
    document.getElementById('avatar-input').addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { alert('La imagen no debe superar 2 MB.'); return; }
      const reader = new FileReader();
      reader.onload = e => {
        const el = document.getElementById('account-avatar-el');
        el.style.backgroundImage = `url(${e.target.result})`;
        el.textContent = '';
        el.dataset.pendingAvatar = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    /* ── Save profile ── */
    async function saveProfile() {
      clearError('profile-error');
      setBtnLoading('btn-save-profile', true, 'Guardar perfil');
      const avatarEl = document.getElementById('account-avatar-el');
      const body = {
        first_name: document.getElementById('f-first-name').value.trim() || null,
        last_name: document.getElementById('f-last-name').value.trim() || null,
      };
      if (avatarEl.dataset.pendingAvatar) body.avatar = avatarEl.dataset.pendingAvatar;
      try {
        const res = await fetch(`${API_BASE}/api/users/me/profile`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!res.ok) { const d = await res.json().catch(()=>({})); showError('profile-error', d.detail || 'Error al guardar.'); return; }
        delete avatarEl.dataset.pendingAvatar;
        await loadUser();
      } catch(e) { showError('profile-error', 'Error de red.'); }
      finally { setBtnLoading('btn-save-profile', false, 'Guardar perfil'); }
    }

    /* ── Save password ── */
    async function savePassword() {
      clearError('pw-error');
      const cur = document.getElementById('f-current-pw').value;
      const nw  = document.getElementById('f-new-pw').value;
      const cnf = document.getElementById('f-confirm-pw').value;
      if (!cur || !nw) { showError('pw-error', 'Completa todos los campos.'); return; }
      if (nw !== cnf) { showError('pw-error', 'Las contraseñas nuevas no coinciden.'); return; }
      if (nw.length < 6) { showError('pw-error', 'La nueva contraseña debe tener al menos 6 caracteres.'); return; }
      setBtnLoading('btn-save-pw', true, 'Cambiar contraseña');
      try {
        const res = await fetch(`${API_BASE}/api/users/me/profile`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ current_password: cur, new_password: nw }),
        });
        if (!res.ok) { const d = await res.json().catch(()=>({})); showError('pw-error', d.detail || 'Error al guardar.'); return; }
        document.getElementById('f-current-pw').value = '';
        document.getElementById('f-new-pw').value = '';
        document.getElementById('f-confirm-pw').value = '';
      } catch(e) { showError('pw-error', 'Error de red.'); }
      finally { setBtnLoading('btn-save-pw', false, 'Cambiar contraseña'); }
    }

    /* ── SMTP state helpers ── */
    function renderSmtpState(hasPassword) {
      const saved = document.getElementById('smtp-saved-row');
      const input = document.getElementById('smtp-input-row');
      if (hasPassword) {
        saved.style.display = 'flex';
        input.style.display = 'none';
      } else {
        saved.style.display = 'none';
        input.style.display = '';
        document.getElementById('btn-cancel-smtp').style.display = 'none';
      }
    }
    function showSmtpInput() {
      document.getElementById('smtp-saved-row').style.display = 'none';
      document.getElementById('smtp-input-row').style.display = '';
      document.getElementById('btn-cancel-smtp').style.display = '';
      document.getElementById('f-smtp-pw').focus();
    }
    function cancelSmtpInput() {
      document.getElementById('f-smtp-pw').value = '';
      clearError('smtp-error');
      renderSmtpState(true);
    }
    async function clearSmtp() {
      if (!confirm('¿Borrar la contraseña de correo guardada?')) return;
      clearError('smtp-error');
      try {
        const res = await fetch(`${API_BASE}/api/users/me/profile`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ clear_smtp_password: true }),
        });
        if (!res.ok) { const d = await res.json().catch(()=>({})); showError('smtp-error', d.detail || 'Error al borrar.'); return; }
        renderSmtpState(false);
      } catch(e) { showError('smtp-error', 'Error de red.'); }
    }

    /* ── Save SMTP password ── */
    async function saveSmtp() {
      clearError('smtp-error');
      const val = document.getElementById('f-smtp-pw').value.trim();
      if (!val) { showError('smtp-error', 'Introduce tu contraseña de Office 365.'); return; }
      setBtnLoading('btn-save-smtp', true, 'Guardar contraseña de correo');
      try {
        const res = await fetch(`${API_BASE}/api/users/me/profile`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ smtp_password: val }),
        });
        if (!res.ok) { const d = await res.json().catch(()=>({})); showError('smtp-error', d.detail || 'Error al guardar.'); return; }
        document.getElementById('f-smtp-pw').value = '';
        renderSmtpState(true);
      } catch(e) { showError('smtp-error', 'Error de red.'); }
      finally { setBtnLoading('btn-save-smtp', false, 'Guardar contraseña de correo'); }
    }

    /* ── Init ── */
    async function init() {
      await initLayout('account');
      await loadUser();
    }
    init();
  </script>
</body>
</html>
